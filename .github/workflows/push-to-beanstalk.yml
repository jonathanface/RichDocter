name: push-to-beanstalk
on:
    push:
        branches:
            - production

jobs:
    create-json:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v2
            - uses: jsdaniell/create-json@1.1.2
              id: config
              with:  
                name: config.json
                json: ${{ secrets.APP_CONFIG }}
            - uses: actions/upload-artifact@v1
              with:
                name: config.json
                path: ${{github.workspace}}/config.json

    beanstalk-zip:
        runs-on: ubuntu-latest
        needs: create-json
        steps:
            - uses: actions/checkout@v2
            - uses: actions/download-artifact@v2
              with:
                name: config.json
            - uses: montudor/action-zip@v1
              with:
                args: zip -qq -r richdocter.zip public .ebextensions Procfile application config.json
            - uses: actions/upload-artifact@v1
              with:
                name: richdocter.zip
                path: ${{ github.workspace }}/richdocter.zip

    beanstalk-deploy:
        runs-on: ubuntu-latest
        needs: beanstalk-zip
        steps:
            - uses: actions/checkout@v2
            - uses: actions/download-artifact@v2
              with:
                name: richdocter.zip
            - uses: aws-actions/configure-aws-credentials@v1
              with:
                aws-access-key-id: ${{ secrets.ACCESS_KEY_ID }}
                aws-secret-access-key: ${{ secrets.SECRET_ACCESS_KEY }}
                aws-region: "us-east-1"
            - name: Upload package to S3 bucket
              run: aws s3 cp richdocter.zip s3://github-transfer-beanstalk/
            - name: Create new ElasticBeanstalk Application Version
              run: |
                aws elasticbeanstalk create-application-version \
                --application-name RichDocter \
                --source-bundle S3Bucket="github-transfer-beanstalk",S3Key="richdocter.zip" \
                --version-label "ver-${{github.sha}}" \
                --description "commit-sha-${{github.sha}}"
            - name: Deploy new ElasticBeanstalk Application Version
              run: aws elasticbeanstalk update-environment --environment-name richdocter-ver2 --version-label "ver-${{ github.sha }}"
            
            

